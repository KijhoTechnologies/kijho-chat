{% extends 'ChatBundle:Default:mainAdmin.html.twig' %}
{% block title %}Chat Bundle{% endblock %}
{% block content %}

    <div class="main-content">

        <div class="row">
            <!-- Raw Links -->
            <div class="col-md-6 pull-right">
                <ul class="list-inline links-list ">
                    <li>
                        <a id="display-chat" href="#" data-toggle="chat" data-animate="1" data-collapse-sidebar="1">
                            <i class="entypo-chat"></i>
                            Chat
                            <span class="badge badge-success chat-notifications-badge is-hidden">0</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <hr />

        <div class="col-lg-12" style="height: 600px; min-height: 600px;">
            <h2>Admin Chat Panel</h2>
            <ul id="message-list">
            </ul>
        </div>
    </div>

    <div id="chat" class="fixed" data-current-user="Art Ramadani" data-order-by-status="1" data-max-chat-history="25">

        <div class="chat-inner">

            <h2 class="chat-header">
                <a href="#" class="chat-close" data-animate="1"><i class="entypo-cancel"></i></a>

                <i class="entypo-users"></i>
                Chat
                <span class="badge badge-success is-hidden">0</span>
            </h2>

            <div class="chat-group" id="group-1">
                <strong>Favorites</strong>

                <a href="#" id="sample-user-123" data-conversation-history="#sample_history"><span class="user-status is-online"></span> <em>Catherine J. Watkins</em></a>
                <a href="#"><span class="user-status is-online"></span> <em>Nicholas R. Walker</em></a>
                <a href="#"><span class="user-status is-busy"></span> <em>Susan J. Best</em></a>
                <a href="#"><span class="user-status is-offline"></span> <em>Brandon S. Young</em></a>
                <a href="#"><span class="user-status is-idle"></span> <em>Fernando G. Olson</em></a>
            </div>

            <div class="chat-group" id="group-2">
                <strong>Work</strong>

                <a href="#"><span class="user-status is-offline"></span> <em>Robert J. Garcia</em></a>
                <a href="#" data-conversation-history="#sample_history_2"><span class="user-status is-offline"></span> <em>Daniel A. Pena</em></a>
                <a href="#"><span class="user-status is-busy"></span> <em>Rodrigo E. Lozano</em></a>
            </div>

            <div class="chat-group online-users" id="group-3">
                <strong>Online Users</strong>
                <a href='#'>Loading...</a>
            </div>

        </div>

        <!-- conversation template -->
        <div class="chat-conversation">
            <div class="conversation-header">
                <a href="#" class="conversation-close"><i class="entypo-cancel"></i></a>

                <span class="user-status"></span>
                <span class="display-name"></span> 
                <small></small>
            </div>

            <ul class="conversation-body">	
            </ul>

            <div class="chat-textarea">
                <textarea class="form-control autogrow" placeholder="Type your message"></textarea>
            </div>
        </div>
    </div>

    <!-- Chat Histories -->
    <ul class="chat-history" id="sample_history">
        <li>
            <span class="user">Art Ramadani</span>
            <p>Are you here?</p>
            <span class="time">09:00</span>
        </li>

        <li class="opponent">
            <span class="user">Catherine J. Watkins</span>
            <p>This message is pre-queued.</p>
            <span class="time">09:25</span>
        </li>

        <li class="opponent">
            <span class="user">Catherine J. Watkins</span>
            <p>Whohoo!</p>
            <span class="time">09:26</span>
        </li>

        <li class="opponent unread">
            <span class="user">Catherine J. Watkins</span>
            <p>Do you like it?</p>
            <span class="time">09:27</span>
        </li>
    </ul>

    <!-- Chat Histories -->
    <ul class="chat-history" id="sample_history_2">
        <li class="opponent unread">
            <span class="user">Daniel A. Pena</span>
            <p>I am going out.</p>
            <span class="time">08:21</span>
        </li>

        <li class="opponent unread">
            <span class="user">Daniel A. Pena</span>
            <p>Call me when you see this message.</p>
            <span class="time">08:27</span>
        </li>
    </ul>

{% endblock %}

{% block scripts %}
    $("#display-chat").trigger('click');
{% endblock %}

{% block other_scripts %}
    {{ ws_client() }}

    <script type="text/javascript">
        var _WS_URI = "ws://{{ gos_web_socket_server_host }}:{{ gos_web_socket_server_port }}";

        var webSocket = WS.connect(_WS_URI);

        webSocket.on("socket/connect", function (session) {
            bindUI(session);
            console.log("Successfully Connected!");
            changeNickname(session)
            joinChatRoom(session);
        });

        webSocket.on("socket/disconnect", function (error) {
            console.log("Disconnected for " + error.reason + " with code " + error.code);
            unbindUI();
        });

        /*Permite cambiar el nickname del usuario*/
        function changeNickname(session)
        {
            session.call("rpc/update_connection_data", {"nickname": "{{nickname}}", "user_type": "{{userType}}"}).then(
                    function (result)
                    {
                        console.log("RPC Valid!", result);
                    },
                    function (error, desc)
                    {
                        console.log("RPC Error", error, desc);
                    }
            );
        }

        // Permite habilitar los eventos sobre los botones de la ventana, cuando hay conexion
        function bindUI(session) {
            $(".send-message").bind("click", function (e) {
                var message = $("#input-message").val();
                if (message != '') {
                    sendMessage(session, message);
                    $("#input-message").val('');
                }
                $("#input-message").focus();
            });
        }

        // Permite deshabilitar los eventos sobre los botones, cuando se pierde la conexion
        function unbindUI() {
            $(".send-message").unbind();
        }

        //permite realizar la conexion a una sala en especifico, y establecer un escucha de eventos
        function joinChatRoom(session) {
            //the callback function in "subscribe" is called everytime an event is published in that channel.
            session.subscribe("chat/channel", serverEvent);
        }

        function sendMessage(session, message) {
            session.publish("chat/channel", message);
        }

        //es la funcion que escucha los eventos del servidor
        function serverEvent(uri, payload) {
            if (payload.msg_type == 'welcome_message') {
                $("#message-list").append('<li>' + payload.msg + '</li>');
            } else if (payload.msg_type == 'user_message') {
                $("#message-list").append('<li>' + payload.msg + '</li>');
            } else if (payload.msg_type == 'online_users_list') {
                refreshOnlineUsers(payload.online_users);
            } else if (payload.msg_type == 'new_client_connected') {
                $("#message-list").append('<li>' + payload.msg + '</li>');
            } else if (payload.msg_type == 'client_left_room') {
                $("#message-list").append('<li>' + payload.msg + '</li>');
            }
        }
        
        function refreshOnlineUsers(onlineUsers) {
            $('.online-users').html('<strong>Online Users</strong>');
            
            for (i = 0; i < onlineUsers.length; i++) {
                var htmlUser = '<a href="#"><span class="user-status is-online"></span> <em>'+onlineUsers[i]+'</em></a>';
                $('.online-users').append(htmlUser);
            }
        }
    </script>
{% endblock %}